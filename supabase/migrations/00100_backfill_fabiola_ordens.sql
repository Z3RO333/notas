-- 00100_backfill_fabiola_ordens.sql
-- Atribui Fabíola Tentunge como responsável em ordens que estavam sem responsável
-- ou atribuídas incorretamente. Atualiza tanto a ordem quanto a nota vinculada.

DO $$
DECLARE
  v_fabiola UUID;
  v_ordens  INTEGER;
  v_notas   INTEGER;
BEGIN
  SELECT id INTO v_fabiola
  FROM public.administradores
  WHERE nome ILIKE '%fabiol%'
  LIMIT 1;

  IF v_fabiola IS NULL THEN
    RAISE EXCEPTION 'Administradora Fabíola não encontrada em public.administradores';
  END IF;

  -- 1. Atualiza administrador_id nas ordens
  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5222232'),('5217444'),('5214930'),('5216522'),('5216943'),
      ('5217612'),('5219288'),('5220546'),('5220549'),('5221720'),
      ('5222236'),('5222668'),('5214058'),('5221231'),('5221877'),
      ('5222482'),('5222793'),('5212036'),('5217522'),('5217523'),
      ('5217961'),('5221743'),('5222536'),('5222537'),('5222608'),
      ('5210058'),('5214425'),('5214392'),('5215626'),('5217940'),
      ('5220543'),('5220760'),('5221210'),('5221695'),('5221782'),
      ('5205842'),('5219616'),('5214520'),('5215490'),('5222231'),
      ('5221196'),('5221731'),('5220962'),('5221456'),('5221570'),
      ('5222293'),('5222615'),('5222771'),('5222772'),('5222795'),
      ('5221780'),('5221053'),('5221883'),('5222532'),('5222808'),
      ('5222294'),('5221985'),('5222614'),('5210493'),('5222811'),
      ('5220876'),('5217626'),('5221857'),('5221858'),('5221859'),
      ('5215493'),('5216402'),('5220963'),('5221569'),('5200276'),
      ('5222991'),('5217642'),('5217607'),('5217608'),('5217644'),
      ('5217645'),('5217834'),('5220796'),('5216927'),('5220627'),
      ('5221345'),('5221575'),('5222557'),('5222558'),('5222641'),
      ('5222813'),('5222613'),('5222699'),('5222740'),('5222618'),
      ('5222523'),('5222529'),('5220884'),('5221935'),('5222359'),
      ('5221105'),('5221457'),('5221514'),('5221579'),('5222533'),
      ('5221893'),('5221895'),('5223079'),('5223179'),('5222616'),
      ('5221722'),('5222238'),('5222792'),('5222799'),('5220885'),
      ('5221113'),('5221300'),('5221301'),('5221786'),('5222535'),
      ('5222812'),('5222904'),('5212521'),('5216411'),('5221744'),
      ('5221919'),('5222281'),('5222296'),('5222297'),('5222298'),
      ('5222299'),('5222520'),('5222521'),('5222522'),('5222524'),
      ('5222525'),('5222765'),('5222798'),('5221890'),('5222305'),
      ('5222361'),('5222538'),('5222785'),('5222787'),('5222789'),
      ('5222790'),('5222791'),('5222235'),('5222484'),('5222898'),
      ('5222899'),('5217643'),('5220907'),('5220908'),('5214322'),
      ('5222282'),('5222481'),('5222534'),('5222967'),('5222972'),
      ('5222975'),('5215218'),('5221730'),('5222034'),('5222228'),
      ('5222483'),('5222609'),('5222693'),('5222796'),('5222809'),
      ('5223173'),('5222230'),('5222303'),('5222897'),('5222172'),
      ('5222797'),('5223227'),('5221781'),('5222619'),('5222709'),
      ('5222763'),('5222362'),('5222498'),('5222617'),('5222435'),
      ('5222436'),('5222437'),('5222438'),('5222738'),('5222739'),
      ('5222820'),('5221984'),('5216448'),('5221675'),('5222350'),
      ('5222439'),('5222711'),('5222712'),('5222767'),('5217349'),
      ('5222304'),('5222766'),('5222923'),('5222924'),('5222925'),
      ('5222926'),('5222927'),('5221568'),('5222102'),('5222505'),
      ('5222506'),('5222507'),('5222508'),('5222509'),('5222510'),
      ('5222511'),('5222512'),('5222513'),('5222514'),('5222515'),
      ('5222516'),('5222517'),('5222786'),('5222788'),('5222977'),
      ('5221678'),('5221973'),('5222057'),('5222058'),('5222284'),
      ('5222286'),('5222518'),('5222519'),('5222560'),('5214511'),
      ('5220795'),('5222561'),('5222562'),('5222563'),('5222768'),
      ('5223162'),('5222114'),('5222526'),('5223174'),('5222147'),
      ('5222292'),('5221230'),('5221787'),('5221918'),('5221956'),
      ('5221892'),('5222100'),('5222188'),('5221510'),('5221981'),
      ('5221983'),('5207786'),('5206471'),('5215494'),('5219617'),
      ('5214379'),('5220902'),('5217359'),('5215746'),('5217823'),
      ('5221517'),('5221519'),('5222280'),('5222301'),('5222485'),
      ('5219299'),('5222300'),('5222764')
  )
  UPDATE public.ordens_notas_acompanhamento o
  SET administrador_id = v_fabiola,
      updated_at       = now()
  FROM alvo a
  WHERE o.ordem_codigo = a.ordem_codigo;

  GET DIAGNOSTICS v_ordens = ROW_COUNT;

  -- 2. Atualiza administrador_id nas notas vinculadas
  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5222232'),('5217444'),('5214930'),('5216522'),('5216943'),
      ('5217612'),('5219288'),('5220546'),('5220549'),('5221720'),
      ('5222236'),('5222668'),('5214058'),('5221231'),('5221877'),
      ('5222482'),('5222793'),('5212036'),('5217522'),('5217523'),
      ('5217961'),('5221743'),('5222536'),('5222537'),('5222608'),
      ('5210058'),('5214425'),('5214392'),('5215626'),('5217940'),
      ('5220543'),('5220760'),('5221210'),('5221695'),('5221782'),
      ('5205842'),('5219616'),('5214520'),('5215490'),('5222231'),
      ('5221196'),('5221731'),('5220962'),('5221456'),('5221570'),
      ('5222293'),('5222615'),('5222771'),('5222772'),('5222795'),
      ('5221780'),('5221053'),('5221883'),('5222532'),('5222808'),
      ('5222294'),('5221985'),('5222614'),('5210493'),('5222811'),
      ('5220876'),('5217626'),('5221857'),('5221858'),('5221859'),
      ('5215493'),('5216402'),('5220963'),('5221569'),('5200276'),
      ('5222991'),('5217642'),('5217607'),('5217608'),('5217644'),
      ('5217645'),('5217834'),('5220796'),('5216927'),('5220627'),
      ('5221345'),('5221575'),('5222557'),('5222558'),('5222641'),
      ('5222813'),('5222613'),('5222699'),('5222740'),('5222618'),
      ('5222523'),('5222529'),('5220884'),('5221935'),('5222359'),
      ('5221105'),('5221457'),('5221514'),('5221579'),('5222533'),
      ('5221893'),('5221895'),('5223079'),('5223179'),('5222616'),
      ('5221722'),('5222238'),('5222792'),('5222799'),('5220885'),
      ('5221113'),('5221300'),('5221301'),('5221786'),('5222535'),
      ('5222812'),('5222904'),('5212521'),('5216411'),('5221744'),
      ('5221919'),('5222281'),('5222296'),('5222297'),('5222298'),
      ('5222299'),('5222520'),('5222521'),('5222522'),('5222524'),
      ('5222525'),('5222765'),('5222798'),('5221890'),('5222305'),
      ('5222361'),('5222538'),('5222785'),('5222787'),('5222789'),
      ('5222790'),('5222791'),('5222235'),('5222484'),('5222898'),
      ('5222899'),('5217643'),('5220907'),('5220908'),('5214322'),
      ('5222282'),('5222481'),('5222534'),('5222967'),('5222972'),
      ('5222975'),('5215218'),('5221730'),('5222034'),('5222228'),
      ('5222483'),('5222609'),('5222693'),('5222796'),('5222809'),
      ('5223173'),('5222230'),('5222303'),('5222897'),('5222172'),
      ('5222797'),('5223227'),('5221781'),('5222619'),('5222709'),
      ('5222763'),('5222362'),('5222498'),('5222617'),('5222435'),
      ('5222436'),('5222437'),('5222438'),('5222738'),('5222739'),
      ('5222820'),('5221984'),('5216448'),('5221675'),('5222350'),
      ('5222439'),('5222711'),('5222712'),('5222767'),('5217349'),
      ('5222304'),('5222766'),('5222923'),('5222924'),('5222925'),
      ('5222926'),('5222927'),('5221568'),('5222102'),('5222505'),
      ('5222506'),('5222507'),('5222508'),('5222509'),('5222510'),
      ('5222511'),('5222512'),('5222513'),('5222514'),('5222515'),
      ('5222516'),('5222517'),('5222786'),('5222788'),('5222977'),
      ('5221678'),('5221973'),('5222057'),('5222058'),('5222284'),
      ('5222286'),('5222518'),('5222519'),('5222560'),('5214511'),
      ('5220795'),('5222561'),('5222562'),('5222563'),('5222768'),
      ('5223162'),('5222114'),('5222526'),('5223174'),('5222147'),
      ('5222292'),('5221230'),('5221787'),('5221918'),('5221956'),
      ('5221892'),('5222100'),('5222188'),('5221510'),('5221981'),
      ('5221983'),('5207786'),('5206471'),('5215494'),('5219617'),
      ('5214379'),('5220902'),('5217359'),('5215746'),('5217823'),
      ('5221517'),('5221519'),('5222280'),('5222301'),('5222485'),
      ('5219299'),('5222300'),('5222764')
  )
  UPDATE public.notas_manutencao nm
  SET administrador_id = v_fabiola,
      updated_at       = now()
  FROM public.ordens_notas_acompanhamento o
  JOIN alvo a ON a.ordem_codigo = o.ordem_codigo
  WHERE nm.id = o.nota_id;

  GET DIAGNOSTICS v_notas = ROW_COUNT;

  RAISE NOTICE 'Backfill Fabíola concluído: % ordens atualizadas, % notas atualizadas', v_ordens, v_notas;
END;
$$;
