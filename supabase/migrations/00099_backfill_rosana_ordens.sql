-- 00099_backfill_rosana_ordens.sql
-- Atribui Rosana Figueira como responsável em ordens que estavam sem responsável
-- ou atribuídas incorretamente. Atualiza tanto a ordem quanto a nota vinculada.

DO $$
DECLARE
  v_rosana UUID;
  v_ordens INTEGER;
  v_notas  INTEGER;
BEGIN
  SELECT id INTO v_rosana
  FROM public.administradores
  WHERE nome ILIKE '%rosana%'
  LIMIT 1;

  IF v_rosana IS NULL THEN
    RAISE EXCEPTION 'Administradora Rosana não encontrada em public.administradores';
  END IF;

  -- 1. Atualiza administrador_id nas ordens
  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5210126'),('5210153'),('5210486'),('5210607'),('5210692'),
      ('5211302'),('5211539'),('5211690'),('5211998'),('5213477'),
      ('5214039'),('5214243'),('5214582'),('5215614'),('5215807'),
      ('5215975'),('5216029'),('5216813'),('5216884'),('5216946'),
      ('5217016'),('5217302'),('5217337'),('5217415'),('5217450'),
      ('5217613'),('5217618'),('5217753'),('5217765'),('5217941'),
      ('5220075'),('5220582'),('5220624'),('5220625'),('5220650'),
      ('5220656'),('5220658'),('5220949'),('5220951'),('5220952'),
      ('5220959'),('5221086'),('5221087'),('5221099'),('5221134'),
      ('5221143'),('5221146'),('5221225'),('5221303'),('5221359'),
      ('5221428'),('5221434'),('5221503'),('5221607'),('5221665'),
      ('5221669'),('5221672'),('5221866'),('5221908'),('5222024'),
      ('5222025'),('5222082'),('5222098'),('5222148'),('5222214'),
      ('5222222'),('5222223'),('5222224'),('5222225'),('5222226'),
      ('5222227'),('5222257'),('5222259'),('5222335'),('5222400'),
      ('5222600'),('5222647'),('5222664'),('5222671'),('5222783'),
      ('5222784'),
      ('5213480'),('5215872'),('5216814'),('5216841'),('5217061'),
      ('5217075'),('5217281'),('5217935'),('5220534'),('5220911'),
      ('5220913'),('5221429'),('5221605'),('5221699'),('5221751'),
      ('5221772'),('5221865'),('5221879'),('5221902'),('5221903'),
      ('5221928'),('5221950'),('5221951'),('5222028'),('5222071'),
      ('5222151'),('5222213'),('5222216'),('5222328'),('5222412'),
      ('5222502'),('5222551'),('5222636'),('5222644'),('5222651'),
      ('5222710'),('5222775'),('5222776'),('5222921'),('5222992'),
      ('5223180'),
      ('5210954'),('5215972'),('5215973'),('5216879'),('5217300'),
      ('5217455'),('5217745'),('5221819'),('5221844'),('5221948'),
      ('5221949'),('5222035'),('5222060'),('5222061'),('5222133'),
      ('5222274'),('5222275'),('5222326'),('5222327'),('5222334'),
      ('5222413'),('5222416'),('5222431'),('5222444'),('5222548'),
      ('5222556'),('5222752'),('5222807'),('5222819'),('5222876'),
      ('5222879'),('5222911'),('5222993'),('5223164'),('5223165'),
      ('5223166'),('5223167'),('5223168'),('5223169'),('5223170'),
      ('5223171'),('5223172'),('5223226'),('5223232'),
      ('5214821'),('5216028'),('5216840'),('5216876'),('5217213'),
      ('5217215'),('5217243'),('5217244'),('5217351'),('5217969'),
      ('5221137'),('5221200'),('5221202'),('5221203'),('5221204'),
      ('5221205'),('5221206'),('5221208'),('5221209'),('5221431'),
      ('5221432'),('5221480'),('5221671'),('5221677'),('5221689'),
      ('5221756'),('5221900'),('5221904'),('5221931'),('5222017'),
      ('5222023'),('5222026'),('5222027'),('5222119'),('5222150'),
      ('5222265'),('5222349'),('5222358'),('5222422'),('5222612'),
      ('5222620'),('5222621'),('5222622'),('5222623'),('5222627'),
      ('5222628'),('5222629'),('5222630'),('5222643'),('5222652'),
      ('5222653'),('5222654'),('5222655'),('5222656'),('5222657'),
      ('5222658'),('5222659'),('5222660'),('5222661'),('5222662'),
      ('5222680'),('5222708'),('5222750'),('5222770'),('5222906'),
      ('5222922'),('5222968'),('5222969'),('5222978'),('5222980'),
      ('5222981'),('5222982'),('5222985'),('5222986'),('5223181'),
      ('5223182'),('5223183'),('5223184'),('5223185'),('5223186'),
      ('5223187'),('5223188'),('5223215'),('5223228'),
      ('5217273'),('5220580'),('5222202'),
      ('5208037'),('5208888'),('5215259'),('5216878'),('5217617'),
      ('5219468'),('5220533'),('5220657'),('5220777'),('5221054'),
      ('5221136'),('5221144'),('5221165'),('5221207'),('5221236'),
      ('5221237'),('5221427'),('5221662'),('5221670'),('5221673'),
      ('5221840'),('5221846'),('5222081'),('5222128'),('5222253'),
      ('5222258'),('5222263'),('5222410'),('5222411'),('5222417'),
      ('5222469'),('5222493'),('5222503'),('5222550'),('5222591'),
      ('5222909')
  )
  UPDATE public.ordens_notas_acompanhamento o
  SET administrador_id = v_rosana,
      updated_at       = now()
  FROM alvo a
  WHERE o.ordem_codigo = a.ordem_codigo;

  GET DIAGNOSTICS v_ordens = ROW_COUNT;

  -- 2. Atualiza administrador_id nas notas vinculadas
  --    (COALESCE na view prioriza nota.administrador_id para PMOS)
  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5210126'),('5210153'),('5210486'),('5210607'),('5210692'),
      ('5211302'),('5211539'),('5211690'),('5211998'),('5213477'),
      ('5214039'),('5214243'),('5214582'),('5215614'),('5215807'),
      ('5215975'),('5216029'),('5216813'),('5216884'),('5216946'),
      ('5217016'),('5217302'),('5217337'),('5217415'),('5217450'),
      ('5217613'),('5217618'),('5217753'),('5217765'),('5217941'),
      ('5220075'),('5220582'),('5220624'),('5220625'),('5220650'),
      ('5220656'),('5220658'),('5220949'),('5220951'),('5220952'),
      ('5220959'),('5221086'),('5221087'),('5221099'),('5221134'),
      ('5221143'),('5221146'),('5221225'),('5221303'),('5221359'),
      ('5221428'),('5221434'),('5221503'),('5221607'),('5221665'),
      ('5221669'),('5221672'),('5221866'),('5221908'),('5222024'),
      ('5222025'),('5222082'),('5222098'),('5222148'),('5222214'),
      ('5222222'),('5222223'),('5222224'),('5222225'),('5222226'),
      ('5222227'),('5222257'),('5222259'),('5222335'),('5222400'),
      ('5222600'),('5222647'),('5222664'),('5222671'),('5222783'),
      ('5222784'),
      ('5213480'),('5215872'),('5216814'),('5216841'),('5217061'),
      ('5217075'),('5217281'),('5217935'),('5220534'),('5220911'),
      ('5220913'),('5221429'),('5221605'),('5221699'),('5221751'),
      ('5221772'),('5221865'),('5221879'),('5221902'),('5221903'),
      ('5221928'),('5221950'),('5221951'),('5222028'),('5222071'),
      ('5222151'),('5222213'),('5222216'),('5222328'),('5222412'),
      ('5222502'),('5222551'),('5222636'),('5222644'),('5222651'),
      ('5222710'),('5222775'),('5222776'),('5222921'),('5222992'),
      ('5223180'),
      ('5210954'),('5215972'),('5215973'),('5216879'),('5217300'),
      ('5217455'),('5217745'),('5221819'),('5221844'),('5221948'),
      ('5221949'),('5222035'),('5222060'),('5222061'),('5222133'),
      ('5222274'),('5222275'),('5222326'),('5222327'),('5222334'),
      ('5222413'),('5222416'),('5222431'),('5222444'),('5222548'),
      ('5222556'),('5222752'),('5222807'),('5222819'),('5222876'),
      ('5222879'),('5222911'),('5222993'),('5223164'),('5223165'),
      ('5223166'),('5223167'),('5223168'),('5223169'),('5223170'),
      ('5223171'),('5223172'),('5223226'),('5223232'),
      ('5214821'),('5216028'),('5216840'),('5216876'),('5217213'),
      ('5217215'),('5217243'),('5217244'),('5217351'),('5217969'),
      ('5221137'),('5221200'),('5221202'),('5221203'),('5221204'),
      ('5221205'),('5221206'),('5221208'),('5221209'),('5221431'),
      ('5221432'),('5221480'),('5221671'),('5221677'),('5221689'),
      ('5221756'),('5221900'),('5221904'),('5221931'),('5222017'),
      ('5222023'),('5222026'),('5222027'),('5222119'),('5222150'),
      ('5222265'),('5222349'),('5222358'),('5222422'),('5222612'),
      ('5222620'),('5222621'),('5222622'),('5222623'),('5222627'),
      ('5222628'),('5222629'),('5222630'),('5222643'),('5222652'),
      ('5222653'),('5222654'),('5222655'),('5222656'),('5222657'),
      ('5222658'),('5222659'),('5222660'),('5222661'),('5222662'),
      ('5222680'),('5222708'),('5222750'),('5222770'),('5222906'),
      ('5222922'),('5222968'),('5222969'),('5222978'),('5222980'),
      ('5222981'),('5222982'),('5222985'),('5222986'),('5223181'),
      ('5223182'),('5223183'),('5223184'),('5223185'),('5223186'),
      ('5223187'),('5223188'),('5223215'),('5223228'),
      ('5217273'),('5220580'),('5222202'),
      ('5208037'),('5208888'),('5215259'),('5216878'),('5217617'),
      ('5219468'),('5220533'),('5220657'),('5220777'),('5221054'),
      ('5221136'),('5221144'),('5221165'),('5221207'),('5221236'),
      ('5221237'),('5221427'),('5221662'),('5221670'),('5221673'),
      ('5221840'),('5221846'),('5222081'),('5222128'),('5222253'),
      ('5222258'),('5222263'),('5222410'),('5222411'),('5222417'),
      ('5222469'),('5222493'),('5222503'),('5222550'),('5222591'),
      ('5222909')
  )
  UPDATE public.notas_manutencao nm
  SET administrador_id = v_rosana,
      updated_at       = now()
  FROM public.ordens_notas_acompanhamento o
  JOIN alvo a ON a.ordem_codigo = o.ordem_codigo
  WHERE nm.id = o.nota_id;

  GET DIAGNOSTICS v_notas = ROW_COUNT;

  RAISE NOTICE 'Backfill Rosana concluído: % ordens atualizadas, % notas atualizadas', v_ordens, v_notas;
END;
$$;
