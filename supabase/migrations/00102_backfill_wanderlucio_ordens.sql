-- 00102_backfill_wanderlucio_ordens.sql
-- Atribui Wanderlucio Mendes como responsável em ordens incorretas.

DO $$
DECLARE
  v_wander UUID;
  v_ordens INTEGER;
  v_notas  INTEGER;
BEGIN
  SELECT id INTO v_wander
  FROM public.administradores
  WHERE nome ILIKE '%wanderlucio%'
  LIMIT 1;

  IF v_wander IS NULL THEN
    RAISE EXCEPTION 'Administrador Wanderlucio não encontrado em public.administradores';
  END IF;

  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5216221'),('5217038'),('5217545'),('5220735'),('5220756'),
      ('5220757'),('5220948'),('5220968'),('5220971'),('5221309'),
      ('5221310'),('5221311'),('5221312'),('5221313'),('5221314'),
      ('5221316'),('5221584'),('5221650'),('5221654'),('5221860'),
      ('5221861'),('5221862'),('5221863'),('5221971'),('5221972'),
      ('5222015'),('5222165'),('5222251'),('5222352'),('5222354'),
      ('5222355'),('5222356'),('5222500'),('5222583'),('5222584'),
      ('5222585'),('5222586'),('5222587'),('5222588'),('5222589'),
      ('5222590'),('5222592'),('5222593'),('5222722'),('5222723'),
      ('5222724'),('5222726'),('5222728'),('5222729'),('5222730'),
      ('5222818'),('5222876'),('5222879'),
      ('5199183'),('5217680'),('5219604'),('5219606'),('5219607'),
      ('5219608'),('5219609'),('5219612'),('5219778'),('5220572'),
      ('5220601'),('5220636'),('5220943'),('5220944'),('5220946'),
      ('5220960'),('5220965'),('5220966'),('5220967'),('5220970'),
      ('5221063'),('5221305'),('5221306'),('5221307'),('5221315'),
      ('5221318'),('5221463'),('5221525'),('5221655'),('5221742'),
      ('5222044'),('5222059'),('5222166'),('5222351'),('5222353'),
      ('5222382'),('5222383'),('5222384'),('5222385'),('5222407'),
      ('5222504'),('5222720'),('5222721'),('5222725'),('5222727'),
      ('5222817')
  )
  UPDATE public.ordens_notas_acompanhamento o
  SET administrador_id = v_wander,
      updated_at       = now()
  FROM alvo a
  WHERE o.ordem_codigo = a.ordem_codigo;

  GET DIAGNOSTICS v_ordens = ROW_COUNT;

  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5216221'),('5217038'),('5217545'),('5220735'),('5220756'),
      ('5220757'),('5220948'),('5220968'),('5220971'),('5221309'),
      ('5221310'),('5221311'),('5221312'),('5221313'),('5221314'),
      ('5221316'),('5221584'),('5221650'),('5221654'),('5221860'),
      ('5221861'),('5221862'),('5221863'),('5221971'),('5221972'),
      ('5222015'),('5222165'),('5222251'),('5222352'),('5222354'),
      ('5222355'),('5222356'),('5222500'),('5222583'),('5222584'),
      ('5222585'),('5222586'),('5222587'),('5222588'),('5222589'),
      ('5222590'),('5222592'),('5222593'),('5222722'),('5222723'),
      ('5222724'),('5222726'),('5222728'),('5222729'),('5222730'),
      ('5222818'),('5222876'),('5222879'),
      ('5199183'),('5217680'),('5219604'),('5219606'),('5219607'),
      ('5219608'),('5219609'),('5219612'),('5219778'),('5220572'),
      ('5220601'),('5220636'),('5220943'),('5220944'),('5220946'),
      ('5220960'),('5220965'),('5220966'),('5220967'),('5220970'),
      ('5221063'),('5221305'),('5221306'),('5221307'),('5221315'),
      ('5221318'),('5221463'),('5221525'),('5221655'),('5221742'),
      ('5222044'),('5222059'),('5222166'),('5222351'),('5222353'),
      ('5222382'),('5222383'),('5222384'),('5222385'),('5222407'),
      ('5222504'),('5222720'),('5222721'),('5222725'),('5222727'),
      ('5222817')
  )
  UPDATE public.notas_manutencao nm
  SET administrador_id = v_wander,
      updated_at       = now()
  FROM public.ordens_notas_acompanhamento o
  JOIN alvo a ON a.ordem_codigo = o.ordem_codigo
  WHERE nm.id = o.nota_id;

  GET DIAGNOSTICS v_notas = ROW_COUNT;

  RAISE NOTICE 'Backfill Wanderlucio concluído: % ordens atualizadas, % notas atualizadas', v_ordens, v_notas;
END;
$$;
