-- 00101_backfill_mayky_ordens.sql
-- Atribui Mayky Castro como responsável em ordens que estavam sem responsável
-- ou atribuídas incorretamente. Atualiza tanto a ordem quanto a nota vinculada.

DO $$
DECLARE
  v_mayky  UUID;
  v_ordens INTEGER;
  v_notas  INTEGER;
BEGIN
  SELECT id INTO v_mayky
  FROM public.administradores
  WHERE nome ILIKE '%mayky%'
  LIMIT 1;

  IF v_mayky IS NULL THEN
    RAISE EXCEPTION 'Administrador Mayky não encontrado em public.administradores';
  END IF;

  -- 1. Atualiza administrador_id nas ordens
  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5196602'),('5197311'),('5198344'),('5198412'),('5198505'),
      ('5199218'),('5199335'),('5200817'),('5202883'),('5202884'),
      ('5203420'),('5203673'),('5203725'),('5204810'),('5205011'),
      ('5205491'),('5205524'),('5206079'),('5206087'),('5206500'),
      ('5206513'),('5206540'),('5206772'),('5207579'),('5208125'),
      ('5208143'),('5208378'),('5208433'),('5208465'),('5208728'),
      ('5208730'),('5208865'),('5209302'),('5209560'),('5209768'),
      ('5210146'),('5210465'),('5210721'),('5210842'),('5210970'),
      ('5210974'),('5210975'),('5211487'),('5211587'),('5211691'),
      ('5211960'),('5211988'),('5212371'),('5212374'),('5212378'),
      ('5212404'),('5212909'),('5212915'),('5212918'),('5213172'),
      ('5213308'),('5213309'),('5213310'),('5213312'),('5213313'),
      ('5213474'),('5213475'),('5213684'),('5213733'),('5213827'),
      ('5213969'),('5213976'),('5213996'),('5214057'),('5214110'),
      ('5214424'),('5214459'),('5214476'),('5214500'),('5214512'),
      ('5214535'),('5214578'),('5214685'),('5214816'),('5214916'),
      ('5214931'),('5215210'),('5215271'),('5215292'),('5215422'),
      ('5215426'),('5215489'),('5215573'),('5215574'),('5215575'),
      ('5215720'),('5215724'),('5215727'),('5215760'),('5215943'),
      ('5216083'),('5216245'),('5216845'),('5216880'),('5216920'),
      ('5217118'),('5217291'),('5217321'),('5217322'),('5217323'),
      ('5217328'),('5217439'),('5217521'),('5217528'),('5217537'),
      ('5217620'),('5217684'),('5217815'),('5217926'),('5217927'),
      ('5217928'),('5219615'),('5220370'),('5220554'),('5220557'),
      ('5220635'),('5220772'),('5220773'),('5220793'),('5220862'),
      ('5220898'),('5220899'),('5220930'),('5220931'),('5220932'),
      ('5220933'),('5220934'),('5220935'),('5220936'),('5221012'),
      ('5221023'),('5221028'),('5221029'),('5221031'),('5221032'),
      ('5221035'),('5221043'),('5221050'),('5221067'),('5221068'),
      ('5221071'),('5221072'),('5221075'),('5221076'),('5221077'),
      ('5221078'),('5221079'),('5221088'),('5221090'),('5221094'),
      ('5221095'),('5221101'),('5221121'),('5221122'),('5221181'),
      ('5221182'),('5221183'),('5221184'),('5221186'),('5221187'),
      ('5221215'),('5221285'),('5221302'),('5221340'),('5221392'),
      ('5221393'),('5221394'),('5221395'),('5221396'),('5221397'),
      ('5221417'),('5221418'),('5221419'),('5221430'),('5221433'),
      ('5221440'),('5221441'),('5221442'),('5221443'),('5221445'),
      ('5221447'),('5221449'),('5221450'),('5221453'),('5221509'),
      ('5221536'),('5221537'),('5221539'),('5221577'),('5221676'),
      ('5221690'),('5221691'),('5221692'),('5221789'),('5221864'),
      ('5221867'),('5221905'),('5221906'),('5221912'),('5221913'),
      ('5221914'),('5221915'),('5221916'),('5221917'),('5221946'),
      ('5221947'),('5221952'),('5221953'),('5221979'),('5221987'),
      ('5222009'),('5222012'),('5222040'),('5222043'),('5222115'),
      ('5222116'),('5222117'),('5222125'),('5222126'),('5222170'),
      ('5222175'),('5222177'),('5222178'),('5222179'),('5222194'),
      ('5222195'),('5222241'),('5222242'),('5222287'),('5222288'),
      ('5222308'),('5222309'),('5222338'),('5222348'),('5222389'),
      ('5222403'),('5222432'),('5222433'),('5222434'),('5222447'),
      ('5222448'),('5222460'),('5222461'),('5222462'),('5222463'),
      ('5222468'),('5222564'),('5222565'),('5222605'),('5222606'),
      ('5222607'),('5222611'),('5222631'),('5222632'),('5222633'),
      ('5222638'),('5222663'),('5222665'),('5222753'),('5222769'),
      ('5222777'),('5222827'),('5222866'),('5222912'),('5222970'),
      ('5222971'),('5222973'),('5222976'),('5223132'),('5223160'),
      ('5223177'),('5223224'),('5223225'),('5223233')
  )
  UPDATE public.ordens_notas_acompanhamento o
  SET administrador_id = v_mayky,
      updated_at       = now()
  FROM alvo a
  WHERE o.ordem_codigo = a.ordem_codigo;

  GET DIAGNOSTICS v_ordens = ROW_COUNT;

  -- 2. Atualiza administrador_id nas notas vinculadas
  WITH alvo (ordem_codigo) AS (
    VALUES
      ('5196602'),('5197311'),('5198344'),('5198412'),('5198505'),
      ('5199218'),('5199335'),('5200817'),('5202883'),('5202884'),
      ('5203420'),('5203673'),('5203725'),('5204810'),('5205011'),
      ('5205491'),('5205524'),('5206079'),('5206087'),('5206500'),
      ('5206513'),('5206540'),('5206772'),('5207579'),('5208125'),
      ('5208143'),('5208378'),('5208433'),('5208465'),('5208728'),
      ('5208730'),('5208865'),('5209302'),('5209560'),('5209768'),
      ('5210146'),('5210465'),('5210721'),('5210842'),('5210970'),
      ('5210974'),('5210975'),('5211487'),('5211587'),('5211691'),
      ('5211960'),('5211988'),('5212371'),('5212374'),('5212378'),
      ('5212404'),('5212909'),('5212915'),('5212918'),('5213172'),
      ('5213308'),('5213309'),('5213310'),('5213312'),('5213313'),
      ('5213474'),('5213475'),('5213684'),('5213733'),('5213827'),
      ('5213969'),('5213976'),('5213996'),('5214057'),('5214110'),
      ('5214424'),('5214459'),('5214476'),('5214500'),('5214512'),
      ('5214535'),('5214578'),('5214685'),('5214816'),('5214916'),
      ('5214931'),('5215210'),('5215271'),('5215292'),('5215422'),
      ('5215426'),('5215489'),('5215573'),('5215574'),('5215575'),
      ('5215720'),('5215724'),('5215727'),('5215760'),('5215943'),
      ('5216083'),('5216245'),('5216845'),('5216880'),('5216920'),
      ('5217118'),('5217291'),('5217321'),('5217322'),('5217323'),
      ('5217328'),('5217439'),('5217521'),('5217528'),('5217537'),
      ('5217620'),('5217684'),('5217815'),('5217926'),('5217927'),
      ('5217928'),('5219615'),('5220370'),('5220554'),('5220557'),
      ('5220635'),('5220772'),('5220773'),('5220793'),('5220862'),
      ('5220898'),('5220899'),('5220930'),('5220931'),('5220932'),
      ('5220933'),('5220934'),('5220935'),('5220936'),('5221012'),
      ('5221023'),('5221028'),('5221029'),('5221031'),('5221032'),
      ('5221035'),('5221043'),('5221050'),('5221067'),('5221068'),
      ('5221071'),('5221072'),('5221075'),('5221076'),('5221077'),
      ('5221078'),('5221079'),('5221088'),('5221090'),('5221094'),
      ('5221095'),('5221101'),('5221121'),('5221122'),('5221181'),
      ('5221182'),('5221183'),('5221184'),('5221186'),('5221187'),
      ('5221215'),('5221285'),('5221302'),('5221340'),('5221392'),
      ('5221393'),('5221394'),('5221395'),('5221396'),('5221397'),
      ('5221417'),('5221418'),('5221419'),('5221430'),('5221433'),
      ('5221440'),('5221441'),('5221442'),('5221443'),('5221445'),
      ('5221447'),('5221449'),('5221450'),('5221453'),('5221509'),
      ('5221536'),('5221537'),('5221539'),('5221577'),('5221676'),
      ('5221690'),('5221691'),('5221692'),('5221789'),('5221864'),
      ('5221867'),('5221905'),('5221906'),('5221912'),('5221913'),
      ('5221914'),('5221915'),('5221916'),('5221917'),('5221946'),
      ('5221947'),('5221952'),('5221953'),('5221979'),('5221987'),
      ('5222009'),('5222012'),('5222040'),('5222043'),('5222115'),
      ('5222116'),('5222117'),('5222125'),('5222126'),('5222170'),
      ('5222175'),('5222177'),('5222178'),('5222179'),('5222194'),
      ('5222195'),('5222241'),('5222242'),('5222287'),('5222288'),
      ('5222308'),('5222309'),('5222338'),('5222348'),('5222389'),
      ('5222403'),('5222432'),('5222433'),('5222434'),('5222447'),
      ('5222448'),('5222460'),('5222461'),('5222462'),('5222463'),
      ('5222468'),('5222564'),('5222565'),('5222605'),('5222606'),
      ('5222607'),('5222611'),('5222631'),('5222632'),('5222633'),
      ('5222638'),('5222663'),('5222665'),('5222753'),('5222769'),
      ('5222777'),('5222827'),('5222866'),('5222912'),('5222970'),
      ('5222971'),('5222973'),('5222976'),('5223132'),('5223160'),
      ('5223177'),('5223224'),('5223225'),('5223233')
  )
  UPDATE public.notas_manutencao nm
  SET administrador_id = v_mayky,
      updated_at       = now()
  FROM public.ordens_notas_acompanhamento o
  JOIN alvo a ON a.ordem_codigo = o.ordem_codigo
  WHERE nm.id = o.nota_id;

  GET DIAGNOSTICS v_notas = ROW_COUNT;

  RAISE NOTICE 'Backfill Mayky concluído: % ordens atualizadas, % notas atualizadas', v_ordens, v_notas;
END;
$$;
